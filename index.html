<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hualca Ingenieros â€” Planner de Tareas</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES â€” PALETA HUALCA INGENIEROS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Corporativos */
  --orange:      #E8601C;
  --orange-dark: #C04D14;
  --orange-light:#F07A3A;
  --orange-pale: #FFF0E8;
  --charcoal:    #1C1C1C;
  --charcoal2:   #2A2A2A;
  --gray-dark:   #3D3D3D;
  --gray-mid:    #6B6B6B;
  --gray-light:  #AEAEAE;
  --gray-pale:   #F4F4F4;
  --white:       #FFFFFF;
  --border:      #E0E0E0;
  --border-dark: #C8C8C8;

  /* Status colors */
  --G: #2E7D32;
  --G-bg: #E8F5E9;
  --D: #1565C0;
  --D-bg: #E3F2FD;
  --V: #6A1B9A;
  --V-bg: #F3E5F5;
  --S: #E65100;
  --S-bg: #FFF3E0;
  --ERR: #C62828;
  --ERR-bg: #FFEBEE;
  --NUM-bg: #F5F5F5;

  /* Layout */
  --task-col: 200px;
  --cell-w:   38px;
  --row-h:    44px;
  --header-h: 46px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--gray-pale);
  color: var(--charcoal);
  font-family: 'Barlow', sans-serif;
  font-size: 14px;
  min-height: 100vh;
}

button { cursor: pointer; font-family: inherit; }
input  { font-family: inherit; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  background: var(--charcoal);
  height: 56px;
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 200;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.topbar-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
}

.logo-mark {
  width: 36px; height: 36px;
  background: var(--orange);
  border-radius: 6px;
  display: grid; place-items: center;
  flex-shrink: 0;
}

.logo-mark svg { width: 22px; height: 22px; fill: white; }

.logo-text {
  font-family: 'Barlow Condensed', sans-serif;
  font-weight: 800;
  font-size: 17px;
  letter-spacing: 0.5px;
  color: var(--white);
  line-height: 1.1;
}

.logo-sub {
  font-weight: 500;
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--orange-light);
  text-transform: uppercase;
  display: block;
}

.topbar-divider {
  width: 1px; height: 28px;
  background: var(--gray-dark);
}

.topbar-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 600;
  letter-spacing: 1px;
  color: var(--gray-light);
  text-transform: uppercase;
}

.topbar-spacer { flex: 1; }

.btn-add-project {
  display: flex; align-items: center; gap: 8px;
  background: var(--orange);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  transition: background 0.15s, transform 0.1s;
}

.btn-add-project:hover  { background: var(--orange-dark); }
.btn-add-project:active { transform: scale(0.97); }
.btn-add-project .icon  { font-size: 18px; line-height: 1; }

/* â”€â”€ Controles globales de fecha â”€â”€ */
.global-date-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.global-date-controls .month-chip {
  min-width: 120px;
  text-align: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  max-width: 100%;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROYECTO CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.proyecto-card {
  background: var(--white);
  border-radius: 10px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  overflow: clip; /* clip respeta border-radius Y permite position:sticky dentro */
  animation: slideIn 0.3s ease both;
}

@keyframes slideIn {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:translateY(0); }
}

/* â”€â”€ Card header â”€â”€ */
.card-header {
  background: var(--charcoal);
  display: flex;
  align-items: center;
  gap: 0;
  flex-wrap: wrap;
}

.card-header-accent {
  width: 6px;
  align-self: stretch;
  background: var(--orange);
  flex-shrink: 0;
}

.card-header-inner {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  flex-wrap: wrap;
}

.card-label {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--orange-light);
  white-space: nowrap;
}

/* â”€â”€ Select de proyecto â”€â”€ */
.project-select {
  flex: 1;
  min-width: 180px;
  max-width: 320px;
  background: rgba(255,255,255,0.07);
  border: 1.5px solid rgba(255,255,255,0.18);
  border-radius: 7px;
  outline: none;
  font-family: 'Barlow', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--white);
  padding: 6px 10px;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23F07A3A' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
}
.project-select:hover  { border-color: rgba(255,255,255,0.35); background-color: rgba(255,255,255,0.1); }
.project-select:focus  { border-color: var(--orange); }
.project-select option { background: var(--charcoal); color: var(--white); font-weight: 500; }

/* â”€â”€ Select + input combo de tarea â”€â”€ */
/* â•â• TASK COMBO â€” select que se convierte en input al elegir "Escribir otra..." â•â• */
.task-combo {
  flex: 1;
  min-width: 0;
  position: relative;
  display: flex;
  align-items: center;
  align-self: stretch;
  height: 100%;
}

/* Select e input se alternan â€” ambos ocupan todo el ancho */
.task-select,
.task-custom-inp {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  font-family: 'Barlow', sans-serif;
  font-size: 12px;
  font-weight: 500;
  color: var(--charcoal);
  padding: 0;
}

/* SELECT visible por defecto */
.task-select {
  display: block;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23C8C8C8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 2px center;
  padding-right: 16px;
}
.task-select option { background: #fff; color: var(--charcoal); }
.task-select option.opt-custom { color: var(--orange); font-style: italic; font-weight: 600; }

/* INPUT oculto por defecto */
.task-custom-inp {
  display: none;
  font-weight: 600;
  padding-right: 20px;
}
.task-custom-inp::placeholder { color: var(--gray-light); font-weight: 400; font-style: italic; }

/* Modo custom: intercambiar visibilidad */
.task-combo.is-custom .task-select   { display: none; }
.task-combo.is-custom .task-custom-inp { display: block; }

/* BotÃ³n â†© volver â€” siempre en el combo, visible solo en modo custom */
.task-back-btn {
  position: absolute;
  right: 2px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--gray-light);
  font-size: 13px;
  cursor: pointer;
  padding: 2px 3px;
  line-height: 1;
  display: none;
  border-radius: 3px;
  transition: color 0.12s, background 0.12s;
  z-index: 2;
}
.task-combo.is-custom .task-back-btn { display: block; }
.task-back-btn:hover { color: var(--orange); background: var(--orange-pale); }

.card-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  flex-wrap: wrap;
}

.ctrl-select {
  background: var(--charcoal2);
  border: 1px solid var(--gray-dark);
  color: var(--gray-light);
  font-family: 'Barlow', sans-serif;
  font-size: 12px;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 5px;
  outline: none;
  transition: border-color 0.15s;
}

.ctrl-select:hover, .ctrl-select:focus { border-color: var(--orange); }
.ctrl-select option { background: var(--charcoal); }

.nav-btn {
  background: none;
  border: 1px solid var(--gray-dark);
  color: var(--gray-light);
  width: 28px; height: 28px;
  border-radius: 5px;
  display: grid; place-items: center;
  font-size: 16px; line-height: 1;
  transition: all 0.15s;
}
.nav-btn:hover { border-color: var(--orange); color: var(--orange); }

.month-chip {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  color: var(--white);
  min-width: 110px;
  text-align: center;
}

.btn-remove-project {
  background: rgba(239,68,68,0.06);
  border: 1.5px solid rgba(239,68,68,0.35);
  color: #e53935;
  height: 30px;
  padding: 0 12px;
  border-radius: 6px;
  display: flex; align-items: center; gap: 6px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, transform 0.1s, box-shadow 0.15s;
  margin-left: 8px;
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(239,68,68,0.1);
}
.btn-remove-project:hover {
  background: #e53935;
  border-color: #e53935;
  color: #fff;
  box-shadow: 0 3px 8px rgba(229,57,53,0.35);
}
.btn-remove-project:active { transform: scale(0.96); }
.btn-remove-project .del-icon { font-size: 14px; line-height: 1; }

/* â”€â”€ Table wrapper â”€â”€ */
.table-wrapper {
  width: 100%;
  /* overflow intencional: none â€” no romper position sticky */
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLA REAL â€” alineaciÃ³n perfecta
   Usamos <table> vÃ­a CSS semÃ¡ntico:
   .proj-table  â†’ table
   .proj-thead  â†’ thead  (sticky)
   .proj-tbody  â†’ tbody
   .proj-tr     â†’ tr
   .proj-th / .proj-td â†’ th/td
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.proj-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;  /* columnas de ancho exacto */
}

/* Columna de nombre de tarea */
.proj-table .col-name {
  width: var(--task-col);
}

/* Columna de cada dÃ­a: ancho calculado con JS via --day-w */
.proj-table .col-day {
  /* se sobreescribe inline con style */
}

/* â”€â”€ THEAD â€” fila de encabezado de dÃ­as â”€â”€ */
.proj-thead {
  position: static;
  background: #F8F8F8;
}

/* Sticky aplicado a cada th individualmente para sobrevivir overflow:hidden del card */
.proj-thead th {
  position: sticky;
  top: 56px;
  z-index: 10;
  background: #F8F8F8;
}

/* Separador inferior del thead usando box-shadow (no border, para que sticky funcione) */
.proj-thead tr {
  border-top: 1px solid var(--border);
}

.proj-thead th {
  box-shadow: 0 2px 0 var(--border-dark);
}

/* TH nombre de tarea */
.th-name {
  padding: 0 12px;
  text-align: left;
  vertical-align: middle;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--gray-mid);
  border-right: 2px solid var(--border-dark);
  height: var(--header-h);
  background: #F8F8F8;
}

/* TH dÃ­a */
.th-day {
  text-align: center;
  vertical-align: middle;
  border-right: 1px solid var(--border);
  height: var(--header-h);
  background: #F8F8F8;
  cursor: default;
  padding: 0;
}
.th-day:last-child { border-right: none; }
.th-day.is-today   { background: var(--orange-pale); }
.th-day.is-weekend { background: #F4F4F4; }

.th-day .dnum {
  display: block;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  font-weight: 700;
  color: var(--charcoal);
  line-height: 1;
}
.th-day.is-today .dnum   { color: var(--orange); }
.th-day.is-weekend .dnum { color: var(--gray-mid); }

.th-day .dletter {
  display: block;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--gray-light);
  line-height: 1;
  margin-top: 2px;
}
.th-day.is-today .dletter   { color: var(--orange-light); }
.th-day.is-weekend .dletter { color: #CCC; }

/* â”€â”€ TBODY â”€â”€ */
.proj-tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
.proj-tbody tr:hover { background: #FAFAFA; }

/* TD nombre de tarea */
.td-name {
  border-right: 2px solid var(--border-dark);
  vertical-align: middle;
  padding: 0 8px 0 12px;
  background: #FDFCFC;
  height: var(--row-h);
}

.td-name-inner {
  display: flex;
  align-items: center;
  gap: 5px;
  height: 100%;
  overflow: visible;
}

.task-idx {
  font-size: 10px;
  color: var(--gray-light);
  font-weight: 600;
  flex-shrink: 0;
  min-width: 16px;
}

/* .task-name-inp reemplazado por .task-select + .task-custom-inp */

.btn-del-task {
  background: none;
  border: none;
  color: transparent;
  font-size: 13px;
  padding: 2px;
  border-radius: 3px;
  transition: all 0.12s;
  flex-shrink: 0;
  line-height: 1;
}
.proj-tbody tr:hover .btn-del-task { color: var(--gray-light); }
.btn-del-task:hover { color: var(--ERR) !important; background: var(--ERR-bg); }

/* TD dÃ­a celda */
.td-day {
  text-align: center;
  vertical-align: middle;
  border-right: 1px solid var(--border);
  padding: 2px;
  height: var(--row-h);
}
.td-day:last-child { border-right: none; }
.td-day.is-today-col   { background: rgba(232,96,28,0.04); }
.td-day.is-weekend-col { background: #FAFAFA; }

.cell-inp {
  width: 90%;
  height: 26px;
  border: 1px solid transparent;
  border-radius: 4px;
  text-align: center;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  color: var(--charcoal);
  background: transparent;
  outline: none;
  cursor: pointer;
  transition: all 0.12s;
  text-transform: uppercase;
  padding: 0 2px;
  display: inline-block;
}

.cell-inp:hover  { background: var(--gray-pale); border-color: var(--border-dark); }
.cell-inp:focus  { background: var(--gray-pale); border-color: var(--orange); cursor: text; }

/* Celda en modo navegaciÃ³n teclado â€” resaltado mÃ¡s visible */
.cell-inp.kbd-active {
  border-color: var(--orange) !important;
  background: var(--orange-pale) !important;
  box-shadow: 0 0 0 2px rgba(232,96,28,0.25);
  outline: none;
}

.cell-inp.v-G   { background: var(--G-bg);   border-color: #A5D6A7; color: var(--G); }
.cell-inp.v-D   { background: var(--D-bg);   border-color: #90CAF9; color: var(--D); }
.cell-inp.v-V   { background: var(--V-bg);   border-color: #CE93D8; color: var(--V); }
.cell-inp.v-S   { background: var(--S-bg);   border-color: #FFCC80; color: var(--S); }
.cell-inp.v-num { background: var(--NUM-bg); border-color: var(--border-dark); color: var(--gray-dark); }
.cell-inp.v-err { background: var(--ERR-bg); border-color: #EF9A9A; color: var(--ERR); animation: shake 0.25s ease; }

@keyframes shake {
  0%,100% { transform:translateX(0); }
  30%      { transform:translateX(-3px); }
  70%      { transform:translateX(3px); }
}

/* â”€â”€ Empty state (sin tareas) â”€â”€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 40px 24px;
  border-top: 1px solid var(--border);
  background: #fafafa;
}

.empty-state-icon {
  width: 44px; height: 44px;
  border-radius: 50%;
  background: var(--orange-pale);
  border: 2px dashed rgba(232,96,28,0.35);
  display: grid; place-items: center;
  font-size: 20px;
  color: var(--orange);
}

.empty-state-msg {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--gray-mid);
  text-align: center;
  max-width: 380px;
  line-height: 1.5;
}

/* â”€â”€ Add task row â”€â”€ */
.add-task-row {
  display: flex;
  align-items: center;
  height: 38px;
  padding: 0 12px;
  gap: 8px;
  cursor: pointer;
  border-top: 1px dashed var(--border-dark);
  background: #FCFCFC;
  transition: background 0.12s;
}
.add-task-row:hover { background: var(--orange-pale); }

.add-plus {
  width: 20px; height: 20px;
  border: 1.5px dashed rgba(232,96,28,0.5);
  border-radius: 4px;
  display: grid; place-items: center;
  font-size: 14px;
  color: var(--orange);
  transition: all 0.12s;
  flex-shrink: 0;
}
.add-task-row:hover .add-plus { background: var(--orange); border-color: var(--orange); color: white; }

.add-label {
  font-size: 12px;
  color: var(--gray-mid);
  font-weight: 500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEGEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.legend {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px 20px;
}

.legend-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gray-mid);
}

.l-item {
  display: flex; align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-dark);
}

.l-chip {
  width: 24px; height: 22px;
  border-radius: 4px;
  display: grid; place-items: center;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  font-weight: 700;
  border: 1px solid;
}

.l-sep { width: 1px; height: 16px; background: var(--border-dark); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-footer {
  text-align: center;
  font-size: 11px;
  color: var(--gray-light);
  padding: 8px 0 24px;
  font-weight: 500;
}

.page-footer span { color: var(--orange); font-weight: 700; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MÃ“VIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 767px) {
  :root {
    --task-col: 120px;
    --row-h:    44px;
    --header-h: 42px;
    --cell-w:   34px;
  }

  .topbar { padding: 0 14px; gap: 8px; flex-wrap: wrap; height: auto; min-height: 56px; padding-top: 8px; padding-bottom: 8px; }
  .global-date-controls .month-chip { display: none; }
  .global-date-controls { gap: 6px; }
  .logo-text { font-size: 14px; }
  .logo-sub  { display: none; }
  .topbar-divider, .topbar-title { display: none; }
  .btn-add-project .txt { display: none; }
  .btn-add-project { padding: 8px 10px; }

  .page { padding: 14px 12px; gap: 16px; }

  .card-header-inner { padding: 8px 10px; gap: 8px; }
  .project-select { font-size: 12px; min-width: 120px; max-width: 200px; }

  /* En mÃ³vil: la tabla tiene min-width fija y se hace scroll */
  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  /* Desactivar sticky en mÃ³vil (no tiene sentido con scroll horizontal) */
  .proj-thead th { position: static; box-shadow: none; border-bottom: 2px solid var(--border-dark); }
  .th-name { font-size: 10px; }
  .col-day { min-width: 32px; }
  .cell-inp { height: 24px; font-size: 12px; }

  .ctrl-select { font-size: 11px; padding: 4px 6px; }
  .month-chip  { min-width: 90px; font-size: 12px; }

  .legend { gap: 8px 12px; }
  .l-item { font-size: 11px; }
}

@media (max-width: 400px) {
  :root { --task-col: 90px; }
  .task-idx { display: none; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP ADVERTENCIA MÃ“VIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(28, 28, 28, 0.82);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeOverlay 0.3s ease both;
}

.mobile-overlay.active { display: flex; }

@keyframes fadeOverlay {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.mobile-popup {
  background: var(--white);
  border-radius: 16px;
  max-width: 360px;
  width: 100%;
  overflow: hidden;
  box-shadow: 0 24px 60px rgba(0,0,0,0.4);
  animation: slidePopup 0.35s cubic-bezier(0.34,1.56,0.64,1) both;
}

@keyframes slidePopup {
  from { opacity: 0; transform: translateY(32px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.popup-header {
  background: var(--charcoal);
  padding: 20px 20px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  position: relative;
}

.popup-header-stripe {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--orange), var(--orange-light));
}

.popup-icon {
  width: 52px; height: 52px;
  background: rgba(232,96,28,0.15);
  border: 2px solid rgba(232,96,28,0.4);
  border-radius: 50%;
  display: grid; place-items: center;
  font-size: 24px;
}

.popup-brand {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--orange-light);
}

.popup-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 18px;
  font-weight: 800;
  letter-spacing: 0.5px;
  color: var(--white);
  text-align: center;
  line-height: 1.2;
}

.popup-body {
  padding: 20px 22px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.popup-message {
  font-size: 13px;
  line-height: 1.65;
  color: var(--gray-dark);
  text-align: center;
}

.popup-message strong {
  color: var(--charcoal);
  font-weight: 700;
}

.popup-devices {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 12px 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.popup-device {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--gray-mid);
}

.popup-device .dev-icon {
  font-size: 26px;
  line-height: 1;
}

.popup-device.recommended .dev-icon { filter: drop-shadow(0 0 6px rgba(232,96,28,0.4)); }
.popup-device.recommended span { color: var(--orange); }

.popup-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.btn-popup-continue {
  background: none;
  border: 1.5px solid var(--border-dark);
  color: var(--gray-mid);
  padding: 10px;
  border-radius: 8px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.btn-popup-continue:hover {
  border-color: var(--gray-mid);
  color: var(--charcoal);
  background: var(--gray-pale);
}

.popup-note {
  font-size: 11px;
  color: var(--gray-light);
  text-align: center;
  line-height: 1.4;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISTA MÃ“VIL â€” cards de tarea con chips de dÃ­as
   Solo aplica a pantallas < 768px
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 767px) {

  /* Ocultar la tabla de escritorio */
  .table-wrapper { display: none !important; }
  /* Mostrar el contenedor de tarjetas mÃ³vil */
  .mobile-cards-wrapper { display: block !important; }

  /* Topbar compacto */
  .topbar {
    padding: 0 14px;
    gap: 8px;
    height: auto;
    min-height: 52px;
    padding-top: 8px;
    padding-bottom: 8px;
    flex-wrap: wrap;
  }
  .logo-sub, .topbar-divider, .topbar-title { display: none; }
  .logo-text { font-size: 14px; }
  .btn-add-project .txt { display: none; }
  .btn-add-project { padding: 8px 10px; }
  .global-date-controls .month-chip { display: none; }
  .global-date-controls { gap: 6px; }
  .ctrl-select { font-size: 11px; padding: 4px 6px; }

  .page { padding: 12px; gap: 14px; }
  .card-header-inner { padding: 8px 10px; gap: 8px; }
  .project-select { font-size: 12px; min-width: 120px; max-width: 200px; }
  .add-task-row { padding: 0 12px; }
  .legend { gap: 8px 12px; }
  .l-item { font-size: 11px; }
}

/* â”€â”€ Contenedor mÃ³vil (oculto en desktop) â”€â”€ */
.mobile-cards-wrapper {
  display: none;
}

/* â”€â”€ Card de tarea mÃ³vil â”€â”€ */
.m-task-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  animation: fadeIn 0.25s ease both;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}

.m-task-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: #FAFAFA;
  border-bottom: 1px solid var(--border);
}

.m-task-num {
  font-size: 10px;
  font-weight: 700;
  color: var(--gray-light);
  flex-shrink: 0;
  min-width: 18px;
}

.m-task-select-wrap {
  flex: 1;
  min-width: 0;
  position: relative;
  display: flex;
  align-items: center;
}

.m-task-select,
.m-task-custom-inp {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--charcoal);
  padding: 0;
}

.m-task-select {
  display: block;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23AEAEAE' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 2px center;
  padding-right: 18px;
}
.m-task-select option { background: #fff; color: var(--charcoal); }
.m-task-select option.opt-custom { color: var(--orange); font-style: italic; }

.m-task-custom-inp {
  display: none;
  font-weight: 600;
  padding-right: 22px;
}
.m-task-custom-inp::placeholder { color: var(--gray-light); font-weight: 400; font-style: italic; }

.m-task-select-wrap.is-custom .m-task-select   { display: none; }
.m-task-select-wrap.is-custom .m-task-custom-inp { display: block; }

.m-task-back-btn {
  position: absolute;
  right: 0; top: 50%;
  transform: translateY(-50%);
  background: none; border: none;
  color: var(--gray-light); font-size: 14px;
  cursor: pointer; padding: 2px;
  display: none; line-height: 1;
  border-radius: 3px;
}
.m-task-select-wrap.is-custom .m-task-back-btn { display: block; }
.m-task-back-btn:hover { color: var(--orange); }

.m-task-del-btn {
  background: none; border: none;
  color: transparent;
  font-size: 14px; cursor: pointer;
  padding: 4px; border-radius: 4px;
  flex-shrink: 0;
  transition: all 0.12s;
  line-height: 1;
}
.m-task-card:hover .m-task-del-btn { color: var(--gray-light); }
.m-task-del-btn:hover { color: var(--ERR) !important; background: var(--ERR-bg); }

/* â”€â”€ Chips de dÃ­as â”€â”€ */
.m-days-strip {
  padding: 8px 10px;
  display: flex;
  gap: 5px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.m-days-strip::-webkit-scrollbar { display: none; }

.m-day-chip {
  flex-shrink: 0;
  width: 40px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--white);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 5px 2px 4px;
  gap: 2px;
  transition: border-color 0.12s, background 0.12s, transform 0.1s;
  -webkit-tap-highlight-color: transparent;
  position: relative;
}
.m-day-chip:active { transform: scale(0.93); }

.m-day-chip.is-today {
  border-color: var(--orange);
  box-shadow: 0 0 0 2px rgba(232,96,28,0.15);
}
.m-day-chip.is-weekend {
  background: #F9F9F9;
}

/* Estados de valor */
.m-day-chip.val-G  { background: var(--G-bg);   border-color: #A5D6A7; }
.m-day-chip.val-D  { background: var(--D-bg);   border-color: #90CAF9; }
.m-day-chip.val-V  { background: var(--V-bg);   border-color: #CE93D8; }
.m-day-chip.val-S  { background: var(--S-bg);   border-color: #FFCC80; }
.m-day-chip.val-num{ background: var(--NUM-bg); border-color: var(--border-dark); }

.m-chip-letter {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--gray-light);
  line-height: 1;
}
.m-day-chip.is-today .m-chip-letter { color: var(--orange); }

.m-chip-num {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  font-weight: 700;
  color: var(--charcoal);
  line-height: 1;
}
.m-day-chip.is-today .m-chip-num { color: var(--orange); }

.m-chip-val {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  font-weight: 800;
  line-height: 1;
  color: transparent; /* invisible si vacÃ­o */
  min-height: 13px;
  display: flex; align-items: center;
}
.m-day-chip.val-G  .m-chip-val { color: var(--G); }
.m-day-chip.val-D  .m-chip-val { color: var(--D); }
.m-day-chip.val-V  .m-chip-val { color: var(--V); }
.m-day-chip.val-S  .m-chip-val { color: var(--S); }
.m-day-chip.val-num .m-chip-val { color: var(--gray-dark); }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INLINE EDITOR â€” selector dentro de la card
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.m-inline-editor {
  display: none;
  padding: 8px 10px 10px;
  border-top: 1px solid var(--border);
  background: #FAFAFA;
  animation: editorIn 0.18s ease both;
}
.m-inline-editor.open { display: block; }

@keyframes editorIn {
  from { opacity: 0; transform: translateY(-4px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Cabecera del editor: muestra el dÃ­a seleccionado */
.ie-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.ie-day-label {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--gray-mid);
}
.ie-close {
  background: none; border: none;
  color: var(--gray-light); font-size: 16px;
  cursor: pointer; padding: 2px 4px;
  border-radius: 4px; line-height: 1;
}
.ie-close:hover { color: var(--charcoal); background: var(--border); }

/* Fila de botones G D V S */
.ie-letter-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 8px;
}
.ie-letter-btn {
  height: 44px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--white);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1px;
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.1s;
}
.ie-letter-btn:active { transform: scale(0.92); }
.ie-letter-btn .il-val {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 18px; font-weight: 800; line-height: 1;
}
.ie-letter-btn .il-label {
  font-size: 8px; font-weight: 600;
  letter-spacing: 0.3px; text-transform: uppercase;
  color: var(--gray-light); line-height: 1;
}
.ie-letter-btn[data-val="G"] { border-color: #A5D6A7; background: var(--G-bg); }
.ie-letter-btn[data-val="G"] .il-val { color: var(--G); }
.ie-letter-btn[data-val="G"].active { background: var(--G); border-color: var(--G); }
.ie-letter-btn[data-val="G"].active .il-val,
.ie-letter-btn[data-val="G"].active .il-label { color: white; }

.ie-letter-btn[data-val="D"] { border-color: #90CAF9; background: var(--D-bg); }
.ie-letter-btn[data-val="D"] .il-val { color: var(--D); }
.ie-letter-btn[data-val="D"].active { background: var(--D); border-color: var(--D); }
.ie-letter-btn[data-val="D"].active .il-val,
.ie-letter-btn[data-val="D"].active .il-label { color: white; }

.ie-letter-btn[data-val="V"] { border-color: #CE93D8; background: var(--V-bg); }
.ie-letter-btn[data-val="V"] .il-val { color: var(--V); }
.ie-letter-btn[data-val="V"].active { background: var(--V); border-color: var(--V); }
.ie-letter-btn[data-val="V"].active .il-val,
.ie-letter-btn[data-val="V"].active .il-label { color: white; }

.ie-letter-btn[data-val="S"] { border-color: #FFCC80; background: var(--S-bg); }
.ie-letter-btn[data-val="S"] .il-val { color: var(--S); }
.ie-letter-btn[data-val="S"].active { background: var(--S); border-color: var(--S); }
.ie-letter-btn[data-val="S"].active .il-val,
.ie-letter-btn[data-val="S"].active .il-label { color: white; }

/* Grilla de horas 1-12 */
.ie-hours-label {
  font-size: 10px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--gray-light); margin-bottom: 5px;
}
.ie-hours-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 5px;
  margin-bottom: 8px;
}
.ie-hour-btn {
  height: 34px;
  border-radius: 6px;
  border: 1.5px solid var(--border);
  background: var(--white);
  cursor: pointer;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 15px; font-weight: 700;
  color: var(--gray-dark);
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.1s;
}
.ie-hour-btn:active  { transform: scale(0.9); }
.ie-hour-btn.active  { background: var(--charcoal); border-color: var(--charcoal); color: white; }

/* BotÃ³n limpiar */
.ie-clear-btn {
  width: 100%;
  height: 34px;
  border-radius: 7px;
  border: 1.5px dashed var(--border-dark);
  background: transparent; cursor: pointer;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px; font-weight: 700;
  letter-spacing: 0.5px; text-transform: uppercase;
  color: var(--gray-mid);
  transition: all 0.12s;
}
.ie-clear-btn:hover { border-color: var(--ERR); color: var(--ERR); background: var(--ERR-bg); }

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     POPUP ADVERTENCIA â€” SOLO MÃ“VIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mobile-overlay" id="mobileOverlay">
  <div class="mobile-popup">
    <div class="popup-header">
      <div class="popup-header-stripe"></div>
      <div class="popup-icon">âš ï¸</div>
      <span class="popup-brand">Hualca Ingenieros</span>
      <h2 class="popup-title">Experiencia no optimizada para mÃ³vil</h2>
    </div>
    <div class="popup-body">
      <p class="popup-message">
        Para garantizar la <strong>correcta visualizaciÃ³n y registro de datos</strong>,
        la AdministraciÃ³n recomienda acceder a esta herramienta desde
        una <strong>computadora o laptop</strong>.<br><br>
        El uso en dispositivos mÃ³viles puede generar
        <strong>errores o pÃ©rdida de informaciÃ³n</strong>.
      </p>
      <div class="popup-devices">
        <div class="popup-device recommended">
          <span class="dev-icon">ğŸ’»</span>
          <span>Computadora</span>
        </div>
        <div class="popup-device recommended">
          <span class="dev-icon">ğŸ–¥ï¸</span>
          <span>Laptop</span>
        </div>
        <div class="popup-device">
          <span class="dev-icon">ğŸ“±</span>
          <span>MÃ³vil</span>
        </div>
      </div>
      <div class="popup-actions">
        <button class="btn-popup-continue" id="btnPopupContinue">
          Ver versiÃ³n mÃ³vil
        </button>
        <p class="popup-note">La vista mÃ³vil estÃ¡ optimizada como tarjetas interactivas. Para mayor precisiÃ³n y productividad, se recomienda el uso en computadora.</p>
      </div>
    </div>
  </div>
</div>

<nav class="topbar">
  <a class="topbar-logo" href="https://www.hualcaingenieros.pe" target="_blank">
    <div class="logo-mark">
      <!-- H icon simplificado -->
      <svg viewBox="0 0 24 24"><path d="M3 3h3v7h12V3h3v18h-3v-8H6v8H3V3z"/></svg>
    </div>
    <div class="logo-text">
      HUALCA
      <span class="logo-sub">Ingenieros</span>
    </div>
  </a>
  <div class="topbar-divider"></div>
  <span class="topbar-title">Planner de Tareas</span>
  <div class="topbar-spacer"></div>
  <!-- Controles globales de mes/aÃ±o -->
  <div class="global-date-controls">
    <button class="nav-btn" id="globalPrev">&#8249;</button>
    <span class="month-chip" id="globalMonthChip"></span>
    <button class="nav-btn" id="globalNext">&#8250;</button>
    <select class="ctrl-select" id="globalMonth"></select>
    <select class="ctrl-select" id="globalYear"></select>
  </div>
  <div class="topbar-divider"></div>
  <button class="btn-add-project" id="btnAddProject">
    <span class="icon">+</span>
    <span class="txt">Nuevo Proyecto</span>
  </button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE CONTENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="page" id="projectsContainer"></main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEYENDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" style="padding-top:0">
  <div class="legend">
    <span class="legend-title">Valores</span>
    <div class="l-item">
      <div class="l-chip" style="background:var(--G-bg);border-color:#A5D6A7;color:var(--G)">G</div>
      Ganado
    </div>
    <div class="l-item">
      <div class="l-chip" style="background:var(--D-bg);border-color:#90CAF9;color:var(--D)">D</div>
      Disponible
    </div>
    <div class="l-item">
      <div class="l-chip" style="background:var(--V-bg);border-color:#CE93D8;color:var(--V)">V</div>
      Vacaciones
    </div>
    <div class="l-item">
      <div class="l-chip" style="background:var(--S-bg);border-color:#FFCC80;color:var(--S)">S</div>
      Suspendido
    </div>
    <div class="l-sep"></div>
    <div class="l-item">
      <div class="l-chip" style="background:var(--NUM-bg);border-color:var(--border-dark);color:var(--gray-dark);font-size:10px">h</div>
      Horas 1â€“12
    </div>
    <div class="l-sep"></div>
    <div class="l-item" style="color:var(--gray-mid);font-size:11px">
      ğŸ’¡ Celdas aceptan: G Â· D Â· V Â· S Â· o nÃºmero del 1 al 12
    </div>
  </div>
  <div class="page-footer">Â© 2025 <span>Hualca Ingenieros</span> â€” IngenierÃ­a de Proyectos</div>
</div>

<script>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP MÃ“VIL â€” mostrar si ancho < 768px
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initMobilePopup() {
  const overlay = document.getElementById('mobileOverlay');
  const btnContinue = document.getElementById('btnPopupContinue');

  // Mostrar solo en mÃ³vil y solo una vez por sesiÃ³n
  const dismissed = sessionStorage.getItem('mobileDismissed');
  if (!dismissed && window.innerWidth < 768) {
    overlay.classList.add('active');
  }

  btnContinue.addEventListener('click', () => {
    overlay.classList.remove('active');
    sessionStorage.setItem('mobileDismissed', '1');
  });

  // TambiÃ©n cerrar si hace tap fuera del popup
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
      sessionStorage.setItem('mobileDismissed', '1');
    }
  });
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISTA MÃ“VIL â€” tarjetas con chips + inline editor
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const isMobile = () => window.innerWidth < 768;

/* â”€â”€ Estado del inline editor activo â”€â”€ */
let ieState = { card: null, tid: null, day: null, p: null };

/* â”€â”€ Genera el HTML del inline editor (vacÃ­o, sin valor seleccionado) â”€â”€ */
function buildInlineEditorHTML(tid, day) {
  const hoursHTML = Array.from({length:12}, (_,i) => {
    const h = i + 1;
    return `<button class="ie-hour-btn" data-val="${h}" data-tid="${tid}" data-day="${day}">${h}</button>`;
  }).join('');

  return `
    <div class="m-inline-editor" data-tid="${tid}" data-day="${day}">
      <div class="ie-header">
        <span class="ie-day-label" id="ie-label-${tid}-${day}"></span>
        <button class="ie-close" data-tid="${tid}" data-day="${day}">âœ•</button>
      </div>
      <div class="ie-letter-row">
        <button class="ie-letter-btn" data-val="G" data-tid="${tid}" data-day="${day}">
          <span class="il-val">G</span><span class="il-label">Ganado</span>
        </button>
        <button class="ie-letter-btn" data-val="D" data-tid="${tid}" data-day="${day}">
          <span class="il-val">D</span><span class="il-label">Disponible</span>
        </button>
        <button class="ie-letter-btn" data-val="V" data-tid="${tid}" data-day="${day}">
          <span class="il-val">V</span><span class="il-label">Vacaciones</span>
        </button>
        <button class="ie-letter-btn" data-val="S" data-tid="${tid}" data-day="${day}">
          <span class="il-val">S</span><span class="il-label">Suspendido</span>
        </button>
      </div>
      <div class="ie-hours-label">Horas (mÃ¡x. 12)</div>
      <div class="ie-hours-grid">${hoursHTML}</div>
      <button class="ie-clear-btn" data-tid="${tid}" data-day="${day}">âœ• Limpiar valor</button>
    </div>`;
}

/* â”€â”€ Renderiza todas las cards mÃ³viles de un proyecto â”€â”€ */
function renderMobileCards(p, card) {
  if (!isMobile()) return;

  const numDays = new Date(globalYear, globalMonth + 1, 0).getDate();
  const today   = new Date();
  const todayD  = (today.getFullYear() === globalYear && today.getMonth() === globalMonth)
                  ? today.getDate() : -1;

  let wrapper = card.querySelector('.mobile-cards-wrapper');
  if (!wrapper) {
    wrapper = document.createElement('div');
    wrapper.className = 'mobile-cards-wrapper';
    card.querySelector('.table-wrapper').after(wrapper);
  }

  wrapper.innerHTML = p.tasks.length === 0
    ? `<div class="empty-state">
         <div class="empty-state-icon">ğŸ“‹</div>
         <p class="empty-state-msg">Es necesario agregar una tarea para guardar la informaciÃ³n</p>
       </div>`
    : p.tasks.map((t, idx) => {
        const isCustom = t.name && !TASK_OPTIONS.includes(t.name);

        const chipsHTML = Array.from({length: numDays}, (_, i) => {
          const d   = i + 1;
          const dow = new Date(globalYear, globalMonth, d).getDay();
          const isWE = dow === 0 || dow === 6;
          const isTd = d === todayD;
          const key  = `${t.id}-${d}`;
          const val  = p.cells[key] || '';
          const valClass = val ? (VALID_LETTERS.includes(val) ? `val-${val}` : 'val-num') : '';
          return `<div class="m-day-chip ${valClass}${isTd?' is-today':''}${isWE?' is-weekend':''}"
                       data-pid="${p.id}" data-tid="${t.id}" data-day="${d}">
            <span class="m-chip-letter">${DAYS_SHORT[dow]}</span>
            <span class="m-chip-num">${d}</span>
            <span class="m-chip-val">${val}</span>
          </div>`;
        }).join('');

        return `<div class="m-task-card" data-pid="${p.id}" data-tid="${t.id}">
          <div class="m-task-header">
            <span class="m-task-num">${String(idx+1).padStart(2,'0')}</span>
            <div class="m-task-select-wrap${isCustom?' is-custom':''}" data-pid="${p.id}" data-tid="${t.id}">
              <select class="m-task-select" data-pid="${p.id}" data-tid="${t.id}">
                <option value="" disabled ${!t.name&&!isCustom?'selected':''}>â€” Seleccionar tarea â€”</option>
                ${TASK_OPTIONS.map(opt=>`<option value="${opt}" ${t.name===opt?'selected':''}>${opt}</option>`).join('')}
                <option value="__custom__" class="opt-custom">âœ Escribir otra...</option>
              </select>
              <input class="m-task-custom-inp" type="text"
                     placeholder="Escribe la tarea..."
                     value="${isCustom ? t.name.replace(/"/g,'&quot;') : ''}"
                     data-pid="${p.id}" data-tid="${t.id}">
              <button class="m-task-back-btn" data-pid="${p.id}" data-tid="${t.id}">â†©</button>
            </div>
            <button class="m-task-del-btn" data-pid="${p.id}" data-tid="${t.id}">âœ•</button>
          </div>
          <div class="m-days-strip" data-pid="${p.id}" data-tid="${t.id}">
            ${chipsHTML}
            ${Array.from({length: numDays}, (_, i) => buildInlineEditorHTML(t.id, i+1)).join('')}
          </div>
        </div>`;
      }).join('');

  bindMobileCards(p, wrapper);
}

/* â”€â”€ Cierra cualquier editor inline abierto en una card â”€â”€ */
function closeAllEditors(wrapper) {
  wrapper.querySelectorAll('.m-inline-editor.open').forEach(ed => ed.classList.remove('open'));
}

/* â”€â”€ Abre el inline editor para el chip tocado â”€â”€ */
function openInlineEditor(p, wrapper, tid, day) {
  // Cerrar el que estuviera abierto
  closeAllEditors(wrapper);

  const editor = wrapper.querySelector(`.m-inline-editor[data-tid="${tid}"][data-day="${day}"]`);
  if (!editor) return;

  // Actualizar etiqueta del dÃ­a
  const dow = new Date(globalYear, globalMonth, day).getDay();
  const lbl = editor.querySelector(`#ie-label-${tid}-${day}`);
  if (lbl) lbl.textContent = `${DAYS_FULL[dow]}, ${day} ${MONTHS_ES[globalMonth]}`;

  // Marcar el valor activo
  const current = p.cells[`${tid}-${day}`] || '';
  editor.querySelectorAll('.ie-letter-btn, .ie-hour-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.val === current);
  });

  editor.classList.add('open');

  // Scroll suave al editor
  setTimeout(() => editor.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
}

/* â”€â”€ Aplica un valor desde el inline editor â”€â”€ */
function applyInlineValue(p, wrapper, tid, day, val) {
  const key  = `${tid}-${day}`;
  const prev = p.cells[key] || '';
  // Toggle: si ya era ese valor, limpiar
  const newVal = prev === val ? '' : val;
  p.cells[key] = newVal;

  // Actualizar botones activos en el editor
  const editor = wrapper.querySelector(`.m-inline-editor[data-tid="${tid}"][data-day="${day}"]`);
  if (editor) {
    editor.querySelectorAll('.ie-letter-btn, .ie-hour-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.val === newVal);
    });
  }

  // Actualizar chip visual
  const chip = wrapper.querySelector(`.m-day-chip[data-tid="${tid}"][data-day="${day}"]`);
  if (chip) {
    chip.classList.remove('val-G','val-D','val-V','val-S','val-num');
    const valSpan = chip.querySelector('.m-chip-val');
    if (newVal) {
      chip.classList.add(VALID_LETTERS.includes(newVal) ? `val-${newVal}` : 'val-num');
      valSpan.textContent = newVal;
    } else {
      valSpan.textContent = '';
    }
  }
}

/* â”€â”€ Bind de todos los eventos de las cards mÃ³viles â”€â”€ */
function bindMobileCards(p, wrapper) {
  // Select de tarea
  wrapper.querySelectorAll('.m-task-select').forEach(sel => {
    sel.addEventListener('change', e => {
      const tid = parseInt(e.target.dataset.tid);
      const t   = p.tasks.find(t => t.id === tid);
      if (!t) return;
      const sw = e.target.closest('.m-task-select-wrap');
      const ci = sw.querySelector('.m-task-custom-inp');
      if (e.target.value === '__custom__') {
        sw.classList.add('is-custom');
        ci.value = ''; t.name = '';
        setTimeout(() => ci.focus(), 50);
      } else {
        sw.classList.remove('is-custom');
        ci.value = ''; t.name = e.target.value;
      }
    });
  });

  // Custom input tarea
  wrapper.querySelectorAll('.m-task-custom-inp').forEach(inp => {
    inp.addEventListener('input', e => {
      const tid = parseInt(e.target.dataset.tid);
      const t   = p.tasks.find(t => t.id === tid);
      if (t) t.name = e.target.value;
    });
  });

  // BotÃ³n volver al select
  wrapper.querySelectorAll('.m-task-back-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tid = parseInt(btn.dataset.tid);
      const t   = p.tasks.find(t => t.id === tid);
      if (!t) return;
      const sw = btn.closest('.m-task-select-wrap');
      sw.classList.remove('is-custom');
      sw.querySelector('.m-task-custom-inp').value = '';
      sw.querySelector('.m-task-select').value = '';
      t.name = '';
    });
  });

  // Eliminar tarea
  wrapper.querySelectorAll('.m-task-del-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      p.tasks = p.tasks.filter(t => t.id !== parseInt(btn.dataset.tid));
      renderProject(p);
    });
  });

  // â”€â”€ Chips: abrir inline editor â”€â”€
  wrapper.querySelectorAll('.m-day-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const tid = parseInt(chip.dataset.tid);
      const day = parseInt(chip.dataset.day);
      const strip = chip.closest('.m-days-strip');
      // Si el editor ya estÃ¡ abierto para este chip, cerrarlo (toggle)
      const ed = strip.querySelector(`.m-inline-editor[data-tid="${tid}"][data-day="${day}"]`);
      if (ed && ed.classList.contains('open')) {
        ed.classList.remove('open');
        return;
      }
      openInlineEditor(p, wrapper, tid, day);
    });
  });

  // â”€â”€ Inline editor: botones de letras â”€â”€
  wrapper.querySelectorAll('.ie-letter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      applyInlineValue(p, wrapper, parseInt(btn.dataset.tid), parseInt(btn.dataset.day), btn.dataset.val);
    });
  });

  // â”€â”€ Inline editor: botones de horas â”€â”€
  wrapper.querySelectorAll('.ie-hour-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      applyInlineValue(p, wrapper, parseInt(btn.dataset.tid), parseInt(btn.dataset.day), btn.dataset.val);
    });
  });

  // â”€â”€ Inline editor: botÃ³n limpiar â”€â”€
  wrapper.querySelectorAll('.ie-clear-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tid = parseInt(btn.dataset.tid);
      const day = parseInt(btn.dataset.day);
      p.cells[`${tid}-${day}`] = '';
      applyInlineValue(p, wrapper, tid, day, '');
      // Forzar limpieza aunque era '' antes (no hay toggle)
      p.cells[`${tid}-${day}`] = '';
      const chip = wrapper.querySelector(`.m-day-chip[data-tid="${tid}"][data-day="${day}"]`);
      if (chip) {
        chip.classList.remove('val-G','val-D','val-V','val-S','val-num');
        chip.querySelector('.m-chip-val').textContent = '';
      }
      const editor = wrapper.querySelector(`.m-inline-editor[data-tid="${tid}"][data-day="${day}"]`);
      if (editor) editor.querySelectorAll('.ie-letter-btn, .ie-hour-btn').forEach(b => b.classList.remove('active'));
    });
  });

  // â”€â”€ Inline editor: botÃ³n cerrar â”€â”€
  wrapper.querySelectorAll('.ie-close').forEach(btn => {
    btn.addEventListener('click', () => closeAllEditors(wrapper));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATOS GLOBALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DAYS_SHORT = ['D','L','M','M','J','V','S'];
const DAYS_FULL  = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
const MONTHS_ES  = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const VALID_LETTERS = ['G','D','V','S'];

// â”€â”€ Opciones de los selects (simuladas â€” luego se conectarÃ¡n a API) â”€â”€
const PROJECT_OPTIONS = [
  'Proyecto 1', 'Proyecto 2', 'Proyecto 3', 'Proyecto 4', 'Proyecto 5'
];

const TASK_OPTIONS = [
  'DiseÃ±o', 'Desarrollo', 'RevisiÃ³n', 'ReuniÃ³n', 'InstalaciÃ³n',
  'SupervisiÃ³n', 'Entrega', 'PlanificaciÃ³n', 'Pruebas', 'DocumentaciÃ³n'
];

// â”€â”€ Estado global de fecha (compartido por todos los proyectos) â”€â”€
const now = new Date();
let globalMonth = now.getMonth();
let globalYear  = now.getFullYear();

let projectCounter = 0;
const projects = []; // {id, name, tasks:[{id,name}], cells:{key:val}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  initMobilePopup();
  buildGlobalDateControls();
  addProject();
  document.getElementById('btnAddProject').addEventListener('click', addProject);
}

/* â”€â”€ Construye los selects globales del topbar â”€â”€ */
function buildGlobalDateControls() {
  const selMonth = document.getElementById('globalMonth');
  const selYear  = document.getElementById('globalYear');
  const chip     = document.getElementById('globalMonthChip');

  MONTHS_ES.forEach((m, i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = m;
    if (i === globalMonth) o.selected = true;
    selMonth.appendChild(o);
  });

  for (let y = 2020; y <= 2035; y++) {
    const o = document.createElement('option');
    o.value = y; o.textContent = y;
    if (y === globalYear) o.selected = true;
    selYear.appendChild(o);
  }

  function updateChip() {
    chip.textContent = `${MONTHS_ES[globalMonth]} ${globalYear}`;
  }
  updateChip();

  document.getElementById('globalPrev').addEventListener('click', () => {
    globalMonth--;
    if (globalMonth < 0) { globalMonth = 11; globalYear--; }
    selMonth.value = globalMonth;
    selYear.value  = globalYear;
    updateChip();
    renderAllProjects();
  });

  document.getElementById('globalNext').addEventListener('click', () => {
    globalMonth++;
    if (globalMonth > 11) { globalMonth = 0; globalYear++; }
    selMonth.value = globalMonth;
    selYear.value  = globalYear;
    updateChip();
    renderAllProjects();
  });

  selMonth.addEventListener('change', () => {
    globalMonth = parseInt(selMonth.value);
    updateChip();
    renderAllProjects();
  });

  selYear.addEventListener('change', () => {
    globalYear = parseInt(selYear.value);
    updateChip();
    renderAllProjects();
  });
}

function renderAllProjects() {
  projects.forEach(p => renderProject(p));
}

function addProject() {
  projectCounter++;
  const p = {
    id: projectCounter,
    name: '',
    tasks: [
      { id: 1, name: 'Tarea 1' },
      { id: 2, name: 'Tarea 2' },
      { id: 3, name: 'Tarea 3' },
    ],
    taskCounter: 3,
    cells: {}
  };
  projects.push(p);
  renderProject(p);

  // Scroll al nuevo proyecto
  setTimeout(() => {
    const card = document.getElementById(`proj-${p.id}`);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 60);
}

function removeProject(pid) {
  const idx = projects.findIndex(p => p.id === pid);
  if (idx !== -1) projects.splice(idx, 1);
  const el = document.getElementById(`proj-${pid}`);
  if (el) el.remove();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER PROJECT
   Usa globalMonth / globalYear
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderProject(p) {
  const container = document.getElementById('projectsContainer');
  let card = document.getElementById(`proj-${p.id}`);

  if (!card) {
    card = document.createElement('div');
    card.className = 'proyecto-card';
    card.id = `proj-${p.id}`;
    container.appendChild(card);
  }

  const numDays = new Date(globalYear, globalMonth + 1, 0).getDate();
  const today   = new Date();
  const todayD  = (today.getFullYear() === globalYear && today.getMonth() === globalMonth)
                  ? today.getDate() : -1;

  // â”€â”€ Header (sin controles de fecha â€” son globales) â”€â”€
  card.innerHTML = `
    <div class="card-header">
      <div class="card-header-accent"></div>
      <div class="card-header-inner">
        <span class="card-label">Proyecto</span>
        <select class="project-select" data-pid="${p.id}">
          <option value="" disabled ${!p.name ? 'selected' : ''}>â€” Seleccionar proyecto â€”</option>
          ${PROJECT_OPTIONS.map(opt =>
            `<option value="${opt}" ${p.name === opt ? 'selected' : ''}>${opt}</option>`
          ).join('')}
        </select>
        <div class="card-controls">
          <button class="btn-remove-project" data-pid="${p.id}" title="Eliminar proyecto"><span class="del-icon">ğŸ—‘</span> Eliminar proyecto</button>
        </div>
      </div>
    </div>
    <div class="table-wrapper">
      ${buildTable(p, numDays, todayD)}
    </div>
    <div class="add-task-row" data-pid="${p.id}">
      <div class="add-plus">+</div>
      <span class="add-label">Agregar una tarea</span>
    </div>
  `;

  bindCard(card, p);
  renderMobileCards(p, card);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD TABLE HTML â€” real <table>
   table-layout: fixed garantiza que
   cada columna tenga el mismo ancho
   en header y en todas las filas.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTable(p, numDays, todayD) {

  // â”€â”€ Sin tareas: retornar empty-state â”€â”€
  if (p.tasks.length === 0) {
    return `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‹</div>
        <p class="empty-state-msg">Es necesario agregar una tarea para guardar la informaciÃ³n</p>
      </div>
    `;
  }

  // â”€â”€ <colgroup> para definir anchos exactos â”€â”€
  let colgroup = `<col class="col-name" style="width:var(--task-col)">`;
  for (let d = 1; d <= numDays; d++) {
    colgroup += `<col class="col-day">`;
  }

  // â”€â”€ <thead> â”€â”€
  let theadCells = `<th class="th-name">Tarea</th>`;
  for (let d = 1; d <= numDays; d++) {
    const dow = new Date(globalYear, globalMonth, d).getDay();
    const isWE = dow === 0 || dow === 6;
    const isTd = d === todayD;
    theadCells += `<th class="th-day${isTd ? ' is-today' : ''}${isWE ? ' is-weekend' : ''}"
                       title="${DAYS_FULL[dow]} ${d}">
      <span class="dnum">${d}</span>
      <span class="dletter">${DAYS_SHORT[dow]}</span>
    </th>`;
  }

  // â”€â”€ <tbody> â”€â”€
  let tbodyRows = '';
  p.tasks.forEach((t, idx) => {
    const isCustom = t.name && !TASK_OPTIONS.includes(t.name);
    let tds = `<td class="td-name">
      <div class="td-name-inner">
        <span class="task-idx">${String(idx+1).padStart(2,'0')}</span>
        <div class="task-combo${isCustom ? ' is-custom' : ''}" data-pid="${p.id}" data-tid="${t.id}">
          <select class="task-select" data-pid="${p.id}" data-tid="${t.id}">
            <option value="" disabled ${!t.name && !isCustom ? 'selected' : ''}>â€” Seleccionar â€”</option>
            ${TASK_OPTIONS.map(opt =>
              `<option value="${opt}" ${t.name === opt ? 'selected' : ''}>${opt}</option>`
            ).join('')}
            <option value="__custom__" class="opt-custom">âœ Escribir otra...</option>
          </select>
          <input class="task-custom-inp" type="text"
                 placeholder="Escribe la tarea..."
                 value="${isCustom ? escHtml(t.name) : ''}"
                 data-pid="${p.id}" data-tid="${t.id}">
          <button class="task-back-btn" data-pid="${p.id}" data-tid="${t.id}" title="Volver al listado">â†©</button>
        </div>
        <button class="btn-del-task" data-pid="${p.id}" data-tid="${t.id}" title="Eliminar">âœ•</button>
      </div>
    </td>`;

    for (let d = 1; d <= numDays; d++) {
      const dow = new Date(globalYear, globalMonth, d).getDay();
      const isWE = dow === 0 || dow === 6;
      const isTd = d === todayD;
      const key  = `${t.id}-${d}`;
      const val  = p.cells[key] || '';
      const cls  = getCellClass(val);
      tds += `<td class="td-day${isTd ? ' is-today-col' : ''}${isWE ? ' is-weekend-col' : ''}">
        <input class="cell-inp${cls ? ' '+cls : ''}" type="text" maxlength="2"
               value="${escHtml(val)}"
               data-pid="${p.id}" data-tid="${t.id}" data-day="${d}">
      </td>`;
    }

    tbodyRows += `<tr>${tds}</tr>`;
  });

  return `
    <table class="proj-table">
      <colgroup>${colgroup}</colgroup>
      <thead class="proj-thead"><tr>${theadCells}</tr></thead>
      <tbody class="proj-tbody">${tbodyRows}</tbody>
    </table>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BIND EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bindCard(card, p) {
  // Project select
  const projSel = card.querySelector('.project-select');
  if (projSel) {
    projSel.addEventListener('change', e => {
      p.name = e.target.value;
    });
  }

  // Remove project
  card.querySelector('.btn-remove-project').addEventListener('click', () => {
    if (projects.length <= 1) return; // siempre al menos 1
    if (confirm('Â¿Eliminar este proyecto?')) removeProject(p.id);
  });

  // Add task
  card.querySelector('.add-task-row').addEventListener('click', () => {
    p.taskCounter++;
    p.tasks.push({ id: p.taskCounter, name: '' });
    renderProject(p);
    setTimeout(() => {
      const sels = card.querySelectorAll('.task-select');
      if (sels.length) sels[sels.length-1].focus();
    }, 30);
  });

  // Task selects
  card.querySelectorAll('.task-select').forEach(sel => {
    sel.addEventListener('change', e => {
      const tid       = parseInt(e.target.dataset.tid);
      const t         = p.tasks.find(t => t.id === tid);
      if (!t) return;
      const combo     = e.target.closest('.task-combo');
      const customInp = combo.querySelector('.task-custom-inp');
      if (e.target.value === '__custom__') {
        combo.classList.add('is-custom');
        customInp.value = '';
        t.name = '';
        setTimeout(() => customInp.focus(), 50);
      } else {
        combo.classList.remove('is-custom');
        customInp.value = '';
        t.name = e.target.value;
      }
    });
  });

  // Task custom inputs
  card.querySelectorAll('.task-custom-inp').forEach(inp => {
    inp.addEventListener('input', e => {
      const tid = parseInt(e.target.dataset.tid);
      const t   = p.tasks.find(t => t.id === tid);
      if (t) t.name = e.target.value;
    });
  });

  // Task back buttons (volver al select desde custom input)
  card.querySelectorAll('.task-back-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const tid       = parseInt(e.target.dataset.tid);
      const t         = p.tasks.find(t => t.id === tid);
      if (!t) return;
      const combo     = e.target.closest('.task-combo');
      const sel       = combo.querySelector('.task-select');
      const customInp = combo.querySelector('.task-custom-inp');
      combo.classList.remove('is-custom');
      customInp.value = '';
      sel.value = '';
      t.name = '';
    });
  });

  // Delete task
  card.querySelectorAll('.btn-del-task').forEach(btn => {
    btn.addEventListener('click', () => {
      p.tasks = p.tasks.filter(t => t.id !== parseInt(btn.dataset.tid));
      renderProject(p);
    });
  });

  // Cell inputs â€” con navegaciÃ³n por teclado
  card.querySelectorAll('.cell-inp').forEach(inp => {
    inp.addEventListener('focus', e => {
      e.target.classList.add('kbd-active');
      e.target.select();
    });
    inp.addEventListener('blur', e => {
      e.target.classList.remove('kbd-active');
      applyCell(e.target, p, true);
    });
    inp.addEventListener('input', e => handleCellInput(e.target, p));
    inp.addEventListener('keydown', e => navigateCell(e, card, p));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVEGACIÃ“N POR TECLADO EN CELDAS
   â”€â”€ Flechas: moverse entre celdas
   â”€â”€ Enter / Tab: avanzar derecha
   â”€â”€ Shift+Tab / Shift+Enter: retroceder izquierda
   â”€â”€ Escape: salir del Ã¡rea
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function navigateCell(e, card, p) {
  const inp = e.target;
  const tid = parseInt(inp.dataset.tid);
  const day = parseInt(inp.dataset.day);

  // Obtener todos los cell-inp del card ordenados: primero por fila (tid), luego por dÃ­a
  const allCells = Array.from(card.querySelectorAll('.cell-inp'));

  // Construir mapa de posiciÃ³n: { "tid-day": index }
  const numDays = new Date(globalYear, globalMonth + 1, 0).getDate();
  const taskIds = [...new Set(allCells.map(c => parseInt(c.dataset.tid)))];
  const numRows = taskIds.length;
  const numCols = numDays;

  // PosiciÃ³n actual
  const rowIdx = taskIds.indexOf(tid);
  const colIdx = day - 1; // day es 1-based

  function focusCell(r, c) {
    if (r < 0 || r >= numRows || c < 0 || c >= numCols) return false;
    const targetTid = taskIds[r];
    const targetDay = c + 1;
    const target = card.querySelector(
      `.cell-inp[data-tid="${targetTid}"][data-day="${targetDay}"]`
    );
    if (target) {
      target.focus();
      target.select();
      return true;
    }
    return false;
  }

  switch (e.key) {
    case 'ArrowRight':
      e.preventDefault();
      // Si la celda tiene valor de 1 dÃ­gito, moverse; si estÃ¡ vacÃ­a tambiÃ©n
      if (!focusCell(rowIdx, colIdx + 1)) {
        // borde derecho: ir a la siguiente fila, primera celda
        focusCell(rowIdx + 1, 0);
      }
      break;

    case 'ArrowLeft':
      e.preventDefault();
      if (!focusCell(rowIdx, colIdx - 1)) {
        // borde izquierdo: ir a la fila anterior, Ãºltima celda
        focusCell(rowIdx - 1, numCols - 1);
      }
      break;

    case 'ArrowDown':
      e.preventDefault();
      focusCell(rowIdx + 1, colIdx);
      break;

    case 'ArrowUp':
      e.preventDefault();
      focusCell(rowIdx - 1, colIdx);
      break;

    case 'Enter':
      e.preventDefault();
      applyCell(inp, p, true);
      // Enter sin Shift â†’ derecha; con Shift â†’ izquierda
      if (e.shiftKey) {
        if (!focusCell(rowIdx, colIdx - 1)) focusCell(rowIdx - 1, numCols - 1);
      } else {
        if (!focusCell(rowIdx, colIdx + 1)) focusCell(rowIdx + 1, 0);
      }
      break;

    case 'Tab':
      // Dejar el Tab nativo pero contenerlo dentro del card
      e.preventDefault();
      applyCell(inp, p, true);
      if (e.shiftKey) {
        if (!focusCell(rowIdx, colIdx - 1)) focusCell(rowIdx - 1, numCols - 1);
      } else {
        if (!focusCell(rowIdx, colIdx + 1)) focusCell(rowIdx + 1, 0);
      }
      break;

    case 'Escape':
      // Salir del Ã¡rea de celdas completamente
      inp.classList.remove('kbd-active');
      inp.blur();
      // Mover foco al nombre de la tarea de esa fila
      const taskSel = card.querySelector(`.task-select[data-tid="${tid}"]`);
      if (taskSel) taskSel.focus();
      break;

    default:
      // Si escribe un valor y la celda ya tiene 1 char, auto-avanzar
      // (lo maneja el input event; aquÃ­ solo si es un solo char vÃ¡lido)
      break;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CELL LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleCellInput(inp, p) {
  // Filtrar solo caracteres vÃ¡lidos
  let raw = inp.value.toUpperCase().replace(/[^GDVS0-9]/g,'');
  inp.value = raw;
  p.cells[`${inp.dataset.tid}-${inp.dataset.day}`] = raw;
  const cls = getCellClass(raw);
  inp.className = 'cell-inp kbd-active' + (cls ? ' '+cls : '');

  // Auto-avanzar al siguiente campo cuando:
  // - Se ingresa una letra vÃ¡lida (G, D, V, S) â†’ siempre 1 char
  // - Se ingresa un nÃºmero de 2 dÃ­gitos
  const isLetter = VALID_LETTERS.includes(raw);
  const isTwoDigit = /^\d{2}$/.test(raw);
  if (isLetter || isTwoDigit) {
    const card = inp.closest('.proyecto-card');
    if (card) {
      const tid     = parseInt(inp.dataset.tid);
      const day     = parseInt(inp.dataset.day);
      const numDays = new Date(globalYear, globalMonth + 1, 0).getDate();
      const allCells = Array.from(card.querySelectorAll('.cell-inp'));
      const taskIds  = [...new Set(allCells.map(c => parseInt(c.dataset.tid)))];
      const rowIdx   = taskIds.indexOf(tid);
      const colIdx   = day - 1;
      const numRows  = taskIds.length;

      function autoFocus(r, c) {
        if (r < 0 || r >= numRows || c < 0 || c >= numDays) return;
        const t = card.querySelector(`.cell-inp[data-tid="${taskIds[r]}"][data-day="${c+1}"]`);
        if (t) { setTimeout(() => { t.focus(); t.select(); }, 30); }
      }

      // Avanzar derecha; si es borde, bajar a la siguiente fila
      if (colIdx + 1 < numDays) autoFocus(rowIdx, colIdx + 1);
      else autoFocus(rowIdx + 1, 0);
    }
  }
}

function applyCell(inp, p, final) {
  let v = inp.value.toUpperCase();
  inp.value = v;
  const key = `${inp.dataset.tid}-${inp.dataset.day}`;

  // Si es nÃºmero, validar rango
  if (v && /^\d+$/.test(v)) {
    const n = parseInt(v);
    if (n < 1)  { v = '1';  inp.value = v; }
    if (n > 12) { v = '12'; inp.value = v; }
  }

  p.cells[key] = v;
  const cls = getCellClass(v, true);
  inp.className = 'cell-inp' + (cls ? ' '+cls : '');
}

function getCellClass(val, strict = false) {
  if (!val) return '';
  const u = val.toUpperCase();
  if (VALID_LETTERS.includes(u) && u.length === 1) return `v-${u}`;
  if (/^\d+$/.test(val)) {
    const n = parseInt(val);
    if (n >= 1 && n <= 12) return 'v-num';
    return strict ? 'v-err' : '';
  }
  return '';
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
init();
</script>
</body>
</html>
